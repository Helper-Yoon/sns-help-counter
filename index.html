<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSì„¼í„° ë„ì›€ ì¹´ìš´íŒ… í”„ë¡œê·¸ë¨</title>
    <!-- CDN ë²„ì „ìœ¼ë¡œ ë³€ê²½ (npm ì„¤ì¹˜ ë¶ˆí•„ìš”) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        .header { text-align: center; margin-bottom: 50px; }
        .header h1 { font-size: 48px; font-weight: 200; margin-bottom: 10px; }
        .header h1 span { color: #1E6FFF; font-weight: 400; }
        .date-display { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .today-info { color: #1E6FFF; font-size: 18px; margin-top: 10px; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #000; border: 1px solid #222; margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .control-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .btn { padding: 10px 25px; background: transparent; color: #666; border: 1px solid #333; font-size: 14px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.3s; }
        .btn:hover { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary:hover { background: #1E6FFF; color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status-indicator { display: flex; align-items: center; gap: 10px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; animation: pulse 2s infinite; }
        .status-dot.active { background: #00FF00; }
        .status-dot.loading { background: #1E6FFF; }
        .status-dot.error { background: #FF0000; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2px; margin-bottom: 50px; background: #111; padding: 2px; }
        .stat-card { background: #000; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .stat-value { font-size: 48px; font-weight: 200; color: #1E6FFF; margin-bottom: 10px; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        
        .ranking-table { background: #000; border: 1px solid #222; margin-bottom: 40px; }
        .table-header { padding: 25px 30px; border-bottom: 1px solid #222; }
        .table-title { font-size: 16px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 20px; text-align: left; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; }
        td { padding: 20px; font-size: 15px; border-bottom: 1px solid #111; }
        tr:hover { background: #050505; }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #111; border: 1px solid #1E6FFF; color: #fff; font-size: 14px; z-index: 1000; animation: slideIn 0.3s; display: none; }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SNSì„¼í„° <span>ë„ì›€ ì¹´ìš´íŒ… í”„ë¡œê·¸ë¨</span></h1>
            <div class="date-display" id="dateDisplay"></div>
            <div class="today-info">ì˜¤ëŠ˜ í•˜ë£¨ ì‹¤ì‹œê°„ ì§‘ê³„</div>
        </div>
        
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="loadData()" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn" onclick="syncData()" id="syncBtn">API ë™ê¸°í™”</button>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ëŒ€ê¸° ì¤‘</span>
                <span id="lastUpdate" style="margin-left: 20px; color: #666;"></span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalHelps">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ë„ì›€ íšŸìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalChars">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì´ ê¸€ììˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeCounselors">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì°¸ì—¬ ìƒë‹´ì‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgChars">0</div>
                <div class="stat-label">í‰ê·  ê¸€ììˆ˜</div>
            </div>
        </div>
        
        <div class="ranking-table">
            <div class="table-header">
                <div class="table-title">ì˜¤ëŠ˜ì˜ ìƒë‹´ì‚¬ ë­í‚¹</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ìƒë‹´ì‚¬</th>
                        <th>ë„ì›€ íšŸìˆ˜</th>
                        <th>ì´ ê¸€ììˆ˜</th>
                        <th>í‰ê·  ê¸€ììˆ˜</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // Supabase ì„¤ì • (UMD ë²„ì „ ì‚¬ìš©)
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        
        // UMD ë²„ì „ì—ì„œëŠ” window.supabase ì‚¬ìš©
        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentData = [];
        
        // ì •í™•í•œ ìƒë‹´ì‚¬ ë§¤í•‘
        const counselorMap = {
            '520798': 'ì±„ì£¼ì€',
            '520799': 'ìœ¤ë„ìš°ë¦¬',
            '521212': 'ì†ì§„ìš°',
            '521213': 'ì°¨ì •í™˜',
            '521214': 'ì„œë¯¼êµ­',
            '521215': 'êµ¬ë³¸ì˜',
            '521217': 'ê¶Œì¬í˜„',
            '521218': 'ì¡°ì‹œí˜„',
            '521220': 'ê¹€ìƒì•„',
            '521221': 'ê¹€ì§€ì›',
            '521222': 'ì •ë‹¤í˜œ',
            '521223': 'ê¹€ì‹œì§„',
            '521224': 'ì‹ í˜œì„œ',
            '521226': 'ì´ë¯¼ì£¼',
            '521227': 'ì •ì£¼ì—°',
            '521230': 'ê¹€ì§„í›„',
            '521231': 'ì´í˜œì˜',
            '521232': 'ê¹€ì˜ì§„',
            '521233': 'ìµœí˜¸ìµ',
            '521234': 'ì„œì •êµ­',
            '521236': 'ë°•í•´ì˜',
            '521239': 'ì´ì¢…ë¯¼',
            '521243': 'ê°•í˜•ìš±',
            '521378': 'ì˜¤ë¯¼ê²½',
            '521379': 'ìµœìˆ˜ëŠ¥',
            '521381': 'ê¹€ì±„ì˜',
            '521382': 'ì „ì§€ìœ¤',
            '521383': 'ì´ìœ ì£¼',
            '521384': 'ê¹€ë²”ì£¼',
            '521385': 'ê¹€ì˜ˆì§„',
            '521386': 'ì°¨ìŠ¹í˜„',
            '521392': 'ì´ì„±ì² ',
            '521393': 'ë°•ì€ì§„',
            '521410': 'ì˜¤ë¯¼í™˜',
            '521416': 'ì „ë¯¸ë€',
            '521564': 'ê¹€êµ­í˜„',
            '521567': 'ê¹€ì„±í˜„',
            '521902': 'ê¹€ì‹œìœ¤',
            '521937': 'ê¹€ì¢…í˜„',
            '521942': 'ì£¼ì€ì§€',
            '521965': 'ê°•í—Œì¤€',
            '522038': 'ë¬¸í™ì£¼',
            '523260': 'ì£¼ìˆ˜í˜„',
            '523268': 'ì˜¤í˜„ìˆ˜',
            '527833': 'ìœ ì¢…í˜„',
            '527836': 'ê¹€ì§„í˜‘',
            '527910': 'ì˜¥ì„œì•„',
            '528425': 'ì •ìš©ìš±',
            '528628': 'ê¹€ì†Œì˜',
            '529149': 'ë™ìˆ˜ì§„',
            '529561': 'í•œìŠ¹ìœ¤',
            '544751': 'ì„±ì¼í›ˆ',
            '555633': 'ì•„ì •ë‹¹',
            '555865': 'ê³µí˜„ì¤€'
        };
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        function getTodayRange() {
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
            return {
                startDate: start.toISOString().split('T')[0],
                endDate: start.toISOString().split('T')[0]
            };
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            // ë‚ ì§œ í‘œì‹œ
            const now = new Date();
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            document.getElementById('dateDisplay').textContent = 
                `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${days[now.getDay()]}ìš”ì¼`;
            
            // ë°ì´í„° ë¡œë“œ
            await loadData();
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            setStatus('loading', 'ë°ì´í„° ë¡œë“œ ì¤‘...');
            
            try {
                const { startDate, endDate } = getTodayRange();
                
                const { data, error } = await supabaseClient
                    .from('counselor_stats')
                    .select('*')
                    .eq('period_start', startDate)
                    .eq('period_end', endDate)
                    .order('help_count', { ascending: false });
                
                if (error) throw error;
                
                currentData = data || [];
                updateUI();
                setStatus('active', 'ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                updateLastTime();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                setStatus('error', 'ë¡œë“œ ì‹¤íŒ¨');
                showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // API ë™ê¸°í™” (ìˆœìˆ˜í•œ ë°ì´í„°ë§Œ)
        async function syncData() {
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            setStatus('loading', 'API ë™ê¸°í™” ì¤‘...');
            
            try {
                // API ì„œë²„ê°€ ìˆë‹¤ë©´ í˜¸ì¶œ
                if (window.location.hostname !== 'localhost' && window.location.protocol !== 'file:') {
                    const response = await fetch('/api/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            sync: true  // ìˆ˜ë™ ë™ê¸°í™” ìš”ì²­
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`ë™ê¸°í™” ì™„ë£Œ: ${result.newMessages || 0}ê°œ ìƒˆ ë©”ì‹œì§€`);
                    } else {
                        showNotification('API ë™ê¸°í™” ì‹¤íŒ¨', 'error');
                    }
                }
                
                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                await loadData();
                
            } catch (error) {
                console.error('API ë™ê¸°í™” ì‹¤íŒ¨:', error);
                showNotification('API ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            // ë°ì´í„°ê°€ ì—†ì„ ë•Œ
            if (!currentData || currentData.length === 0) {
                // í†µê³„ë¥¼ 0ìœ¼ë¡œ
                document.getElementById('totalHelps').textContent = '0';
                document.getElementById('totalChars').textContent = '0';
                document.getElementById('activeCounselors').textContent = '0';
                document.getElementById('avgChars').textContent = '0';
                
                // í…Œì´ë¸”ì— "ë°ì´í„° ì—†ìŒ" í‘œì‹œ
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center;padding:50px;color:#666;">
                            <div style="font-size:18px;margin-bottom:10px;">ğŸ“Š ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            <div style="font-size:14px;">Webhookì„ í†µí•´ ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
                            <div style="font-size:12px;margin-top:10px;color:#999;">ë˜ëŠ” "API ë™ê¸°í™”" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë™ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // í†µê³„ ê³„ì‚°
            const totalHelps = currentData.reduce((sum, item) => sum + item.help_count, 0);
            const totalChars = currentData.reduce((sum, item) => sum + item.total_chars, 0);
            const avgChars = totalHelps > 0 ? Math.round(totalChars / totalHelps) : 0;
            
            // ìˆ«ì ì—…ë°ì´íŠ¸
            document.getElementById('totalHelps').textContent = totalHelps.toLocaleString();
            document.getElementById('totalChars').textContent = totalChars.toLocaleString();
            document.getElementById('activeCounselors').textContent = currentData.length;
            document.getElementById('avgChars').textContent = avgChars.toLocaleString();
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = currentData.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        ${item.counselor_name}
                        <br><small style="color:#666">${item.counselor_id}</small>
                    </td>
                    <td>${item.help_count.toLocaleString()}</td>
                    <td>${item.total_chars.toLocaleString()}</td>
                    <td>${item.avg_chars.toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        // ìƒíƒœ í‘œì‹œ
        function setStatus(type, text) {
            document.getElementById('statusDot').className = 'status-dot ' + type;
            document.getElementById('statusText').textContent = text;
        }
        
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        }
        
        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.borderColor = type === 'error' ? '#FF0000' : '#1E6FFF';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ì‹œì‘
        init();
    </script>
</body>
</html>
