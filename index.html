<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채널톡 비담당 상담 추적 시스템</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif; 
            background: #000; 
            color: #fff; 
            min-height: 100vh; 
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 40px 20px; }
        
        /* 헤더 스타일 */
        .header { 
            text-align: center; 
            margin-bottom: 50px;
            padding: 30px;
            background: #000;
            border: 1px solid #222;
        }
        .header h1 { 
            font-size: 52px; 
            font-weight: 200; 
            margin-bottom: 15px;
        }
        .header h1 span { 
            color: #1E6FFF; 
            font-weight: 400;
        }
        .subtitle { 
            color: #999; 
            font-size: 16px; 
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        .date-display { 
            color: #888; 
            font-size: 15px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin-top: 20px;
        }
        .today-info { 
            color: #1E6FFF; 
            font-size: 20px; 
            margin-top: 10px;
            font-weight: 300;
        }
        
        /* 실시간 상태 표시 */
        .realtime-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #111;
            padding: 15px 20px;
            border: 1px solid #333;
            border-radius: 4px;
            z-index: 1000;
        }
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00FF00;
            animation: pulse 2s infinite;
        }
        .pulse-dot.disconnected { background: #FF0000; }
        .pulse-dot.connecting { background: #FFD700; }
        
        /* 컨트롤 바 */
        .control-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px 30px; 
            background: #000; 
            border: 1px solid #222;
            margin-bottom: 40px; 
            flex-wrap: wrap; 
            gap: 20px;
        }
        .control-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .btn { 
            padding: 12px 30px; 
            background: transparent; 
            color: #999; 
            border: 1px solid #333; 
            font-size: 15px; 
            font-weight: 500; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .btn:hover { 
            color: #1E6FFF; 
            border-color: #1E6FFF;
        }
        .btn.primary { 
            color: #1E6FFF; 
            border-color: #1E6FFF;
        }
        .btn.primary:hover { 
            background: #1E6FFF; 
            color: #000;
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        /* 상태 인디케이터 */
        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: #666; 
            animation: pulse 2s infinite;
        }
        .status-dot.active { background: #00FF00; }
        .status-dot.loading { background: #1E6FFF; }
        .status-dot.error { background: #FF0000; }
        
        /* 통계 카드 그리드 */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 2px; 
            margin-bottom: 50px;
            background: #111;
            padding: 2px;
        }
        .stat-card { 
            background: #000; 
            padding: 35px; 
            text-align: center; 
            position: relative; 
            overflow: hidden;
        }
        .stat-card:hover {
            background: #050505;
        }
        .stat-icon {
            font-size: 36px;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        .stat-value { 
            font-size: 52px; 
            font-weight: 200; 
            color: #1E6FFF; 
            margin-bottom: 12px;
            font-variant-numeric: tabular-nums;
        }
        .stat-label { 
            font-size: 14px; 
            color: #888; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-weight: 400;
        }
        .stat-change {
            font-size: 15px;
            color: #00FF00;
            margin-top: 10px;
            font-weight: 500;
        }
        .stat-change.down { color: #FF4444; }
        
        /* 실시간 활동 피드 */
        .activity-feed {
            background: #000;
            border: 1px solid #222;
            margin-bottom: 40px;
            max-height: 500px;
            overflow: hidden;
        }
        .feed-header {
            padding: 25px 30px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .feed-title {
            font-size: 17px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #1E6FFF;
        }
        .feed-count {
            color: #888;
            font-size: 14px;
        }
        .feed-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
        }
        .activity-item {
            padding: 20px 30px;
            border-bottom: 1px solid #111;
            transition: all 0.2s;
        }
        .activity-item:hover {
            background: #050505;
        }
        .activity-time {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .activity-text {
            font-size: 16px;
            line-height: 1.6;
            color: #ccc;
        }
        .activity-counselor {
            color: #1E6FFF;
            font-weight: 500;
        }
        .activity-customer {
            color: #FFD700;
            font-weight: 500;
        }
        .activity-chars {
            color: #888;
            font-size: 14px;
            margin-left: 10px;
        }
        
        /* 랭킹 테이블 */
        .ranking-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        @media (max-width: 1024px) {
            .ranking-section { grid-template-columns: 1fr; }
        }
        
        .ranking-table { 
            background: #000;
            border: 1px solid #222;
        }
        .table-header { 
            padding: 25px 30px;
            border-bottom: 1px solid #222;
        }
        .table-title { 
            font-size: 17px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #1E6FFF;
        }
        table { 
            width: 100%; 
            border-collapse: collapse;
        }
        th { 
            padding: 20px; 
            text-align: left; 
            font-size: 13px; 
            color: #888; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            border-bottom: 1px solid #222;
            font-weight: 500;
        }
        td { 
            padding: 20px; 
            font-size: 16px; 
            border-bottom: 1px solid #111;
            color: #ccc;
            font-variant-numeric: tabular-nums;
        }
        tr:hover { 
            background: #050505;
        }
        .rank-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            border-radius: 50%;
            font-weight: 600;
            font-size: 16px;
            background: #111;
            border: 1px solid #333;
        }
        .rank-1 { 
            background: #FFD700; 
            color: #000;
            border: none;
        }
        .rank-2 { 
            background: #C0C0C0; 
            color: #000;
            border: none;
        }
        .rank-3 { 
            background: #CD7F32; 
            color: #fff;
            border: none;
        }
        
        /* 알림 */
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 18px 25px; 
            background: #111;
            border: 1px solid #1E6FFF;
            color: #fff; 
            font-size: 15px;
            font-weight: 500;
            z-index: 1000; 
            animation: slideIn 0.3s; 
            display: none;
        }
        .notification.show { display: block; }
        .notification.error { 
            border-color: #FF0000;
        }
        .notification.success {
            border-color: #00FF00;
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes slideIn { 
            from { transform: translateX(100%); } 
            to { transform: translateX(0); } 
        }
        
        /* 스크롤바 스타일 */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { 
            background: #333; 
            border-radius: 0;
        }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* 로딩 스피너 */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #333;
            border-radius: 50%;
            border-top-color: #1E6FFF;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 36px; }
            .stat-value { font-size: 42px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 실시간 연결 상태 -->
        <div class="realtime-status">
            <div class="realtime-indicator">
                <span class="pulse-dot" id="realtimeDot"></span>
                <span id="realtimeText" style="color: #888; font-size: 13px;">연결 대기중</span>
            </div>
        </div>

        <!-- 헤더 -->
        <div class="header">
            <h1>채널톡 <span>비담당 상담 추적</span></h1>
            <div class="subtitle">담당자(ASSIGNEE)가 아닌 매니저의 답변을 실시간으로 모니터링합니다</div>
            <div class="date-display" id="dateDisplay"></div>
            <div class="today-info">오늘 하루 실시간 집계</div>
        </div>
        
        <!-- 컨트롤 바 -->
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="app.loadData()" id="refreshBtn">새로고침</button>
                <button class="btn" onclick="app.syncChannelTalk()" id="syncBtn">채널톡 동기화</button>
                <button class="btn" onclick="app.exportData()" id="exportBtn">데이터 내보내기</button>
                <button class="btn" onclick="app.generateDemoData()" id="demoBtn">데모 데이터</button>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText" style="color: #888;">대기 중</span>
                <span id="lastUpdate" style="margin-left: 20px; color: #888;"></span>
            </div>
        </div>
        
        <!-- 통계 카드 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">💬</div>
                <div class="stat-value" id="totalNonAssignee">0</div>
                <div class="stat-label">오늘 비담당 답변</div>
                <div class="stat-change" id="changeNonAssignee">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✍️</div>
                <div class="stat-value" id="totalChars">0</div>
                <div class="stat-label">오늘 총 글자수</div>
                <div class="stat-change" id="changeChars">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-value" id="activeManagers">0</div>
                <div class="stat-label">활동 매니저</div>
                <div class="stat-change" id="changeManagers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⏱️</div>
                <div class="stat-value" id="avgResponseTime">0</div>
                <div class="stat-label">평균 응답시간(분)</div>
                <div class="stat-change" id="changeResponseTime">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-value" id="avgChars">0</div>
                <div class="stat-label">평균 글자수</div>
                <div class="stat-change" id="changeAvgChars">-</div>
            </div>
        </div>
        
        <!-- 실시간 활동 피드 -->
        <div class="activity-feed">
            <div class="feed-header">
                <div class="feed-title">실시간 활동</div>
                <span class="feed-count" id="feedCount">0개 활동</span>
            </div>
            <div class="feed-content" id="activityFeed">
                <div style="padding: 50px; text-align: center; color: #666;">
                    실시간 활동이 여기에 표시됩니다
                </div>
            </div>
        </div>
        
        <!-- 랭킹 테이블 -->
        <div class="ranking-section">
            <!-- 오늘의 매니저 랭킹 -->
            <div class="ranking-table">
                <div class="table-header">
                    <div class="table-title">오늘의 비담당 도움 랭킹</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th width="80">순위</th>
                            <th>매니저</th>
                            <th width="100">횟수</th>
                            <th width="120">글자수</th>
                            <th width="120">평균</th>
                        </tr>
                    </thead>
                    <tbody id="todayRanking">
                        <tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">
                            데이터를 불러오는 중...
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 시간대별 통계 -->
            <div class="ranking-table">
                <div class="table-header">
                    <div class="table-title">시간대별 활동 통계</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>시간대</th>
                            <th>답변 수</th>
                            <th>매니저</th>
                            <th>평균 글자</th>
                        </tr>
                    </thead>
                    <tbody id="hourlyStats">
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#666;">
                            데이터를 불러오는 중...
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // ✅ Supabase 설정 (키 자동 적용 완료!)
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 채널톡 매니저(상담사) 매핑
        const managerMap = {
            '520798': '채주은', '520799': '윤도우리', '521212': '손진우',
            '521213': '차정환', '521214': '서민국', '521215': '구본영',
            '521217': '권재현', '521218': '조시현', '521220': '김상아',
            '521221': '김지원', '521222': '정다혜', '521223': '김시진',
            '521224': '신혜서', '521226': '이민주', '521227': '정주연',
            '521230': '김진후', '521231': '이혜영', '521232': '김영진',
            '521233': '최호익', '521234': '서정국', '521236': '박해영',
            '521239': '이종민', '521243': '강형욱', '521378': '오민경',
            '521379': '최수능', '521381': '김채영', '521382': '전지윤',
            '521383': '이유주', '521384': '김범주', '521385': '김예진',
            '521386': '차승현', '521392': '이성철', '521393': '박은진',
            '521410': '오민환', '521416': '전미란', '521564': '김국현',
            '521567': '김성현', '521902': '김시윤', '521937': '김종현',
            '521942': '주은지', '521965': '강헌준', '522038': '문홍주',
            '523260': '주수현', '523268': '오현수', '527833': '유종현',
            '527836': '김진협', '527910': '옥서아', '528425': '정용욱',
            '528628': '김소영', '529149': '동수진', '529561': '한승윤',
            '544751': '성일훈', '555633': '아정당', '555865': '공현준'
        };
        
        // 앱 상태 관리
        const app = {
            currentData: [],
            realtimeChannel: null,
            activityFeed: [],
            lastStats: {},
            
            // 초기화
            async init() {
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 60000);
                
                await this.loadData();
                this.setupRealtime();
                
                // 자동 새로고침 (5분마다)
                setInterval(() => this.loadData(), 300000);
            },
            
            // 날짜시간 업데이트
            updateDateTime() {
                const now = new Date();
                const days = ['일', '월', '화', '수', '목', '금', '토'];
                document.getElementById('dateDisplay').textContent = 
                    `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 ${days[now.getDay()]}요일`;
                document.getElementById('lastUpdate').textContent = 
                    `마지막 업데이트: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            },
            
            // 데이터 로드
            async loadData() {
                const btn = document.getElementById('refreshBtn');
                btn.disabled = true;
                this.setStatus('loading', '데이터 로드 중...');
                
                try {
                    // 오늘 날짜
                    const today = new Date();
                    const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
                    const endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString();
                    
                    // 비담당 답변 데이터 가져오기
                    const { data: responses, error } = await supabase
                        .from('channel_non_assignee_responses')
                        .select('*')
                        .gte('created_at', startDate)
                        .lt('created_at', endDate)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    this.currentData = responses || [];
                    this.updateUI();
                    this.updateDateTime();
                    this.setStatus('active', '업데이트 완료');
                    
                } catch (error) {
                    console.error('데이터 로드 실패:', error);
                    this.setStatus('error', '로드 실패');
                    this.showNotification('데이터 로드 실패', 'error');
                } finally {
                    btn.disabled = false;
                }
            },
            
            // 데모 데이터 생성
            async generateDemoData() {
                const btn = document.getElementById('demoBtn');
                btn.disabled = true;
                this.setStatus('loading', '데모 데이터 생성 중...');
                
                try {
                    const managers = Object.entries(managerMap).slice(0, 10);
                    const customers = ['고객A', '고객B', '고객C', '고객D', '고객E'];
                    
                    for (let i = 0; i < 20; i++) {
                        const [managerId, managerName] = managers[Math.floor(Math.random() * managers.length)];
                        const [assigneeId, assigneeName] = managers[Math.floor(Math.random() * managers.length)];
                        
                        // 담당자가 아닌 경우만 생성
                        if (managerId !== assigneeId) {
                            const charCount = Math.floor(Math.random() * 500) + 100;
                            
                            await supabase.from('channel_non_assignee_responses').insert({
                                manager_id: managerId,
                                manager_name: managerName,
                                user_chat_id: `chat_${Date.now()}_${i}`,
                                assignee_id: assigneeId,
                                customer_name: customers[Math.floor(Math.random() * customers.length)],
                                message_content: '데모 메시지 내용입니다.',
                                char_count: charCount,
                                response_time: Math.floor(Math.random() * 10) + 1,
                                is_helpful: Math.random() > 0.3,
                                created_at: new Date()
                            });
                        }
                    }
                    
                    await this.loadData();
                    this.showNotification('데모 데이터 생성 완료', 'success');
                    
                } catch (error) {
                    console.error('데모 데이터 생성 실패:', error);
                    this.showNotification('생성 실패', 'error');
                } finally {
                    btn.disabled = false;
                }
            },
            
            // UI 업데이트
            updateUI() {
                // 통계 계산
                const stats = this.calculateStats();
                
                // 통계 카드 업데이트
                this.updateStatCard('totalNonAssignee', stats.totalResponses);
                this.updateStatCard('totalChars', stats.totalChars);
                this.updateStatCard('activeManagers', stats.activeManagers);
                this.updateStatCard('avgResponseTime', stats.avgResponseTime);
                this.updateStatCard('avgChars', stats.avgChars);
                
                // 랭킹 업데이트
                this.updateRanking(stats.managerStats);
                
                // 시간대별 통계 업데이트
                this.updateHourlyStats(stats.hourlyStats);
                
                // 이전 통계와 비교
                this.compareStats(stats);
                this.lastStats = stats;
            },
            
            // 통계 계산
            calculateStats() {
                const managerStats = {};
                const hourlyStats = {};
                let totalChars = 0;
                let totalResponseTime = 0;
                let responseCount = 0;
                
                this.currentData.forEach(item => {
                    // 매니저별 통계
                    const managerId = item.manager_id;
                    const managerName = item.manager_name || managerMap[managerId] || `매니저${managerId}`;
                    
                    if (!managerStats[managerId]) {
                        managerStats[managerId] = {
                            name: managerName,
                            count: 0,
                            chars: 0
                        };
                    }
                    managerStats[managerId].count++;
                    managerStats[managerId].chars += item.char_count || 0;
                    
                    // 시간대별 통계
                    const hour = new Date(item.created_at).getHours();
                    if (!hourlyStats[hour]) {
                        hourlyStats[hour] = {
                            count: 0,
                            chars: 0,
                            managers: new Set()
                        };
                    }
                    hourlyStats[hour].count++;
                    hourlyStats[hour].chars += item.char_count || 0;
                    hourlyStats[hour].managers.add(managerId);
                    
                    // 전체 통계
                    totalChars += item.char_count || 0;
                    
                    if (item.response_time) {
                        totalResponseTime += item.response_time;
                        responseCount++;
                    }
                });
                
                return {
                    totalResponses: this.currentData.length,
                    totalChars: totalChars,
                    activeManagers: Object.keys(managerStats).length,
                    avgResponseTime: responseCount > 0 ? Math.round(totalResponseTime / responseCount) : 0,
                    avgChars: this.currentData.length > 0 ? Math.round(totalChars / this.currentData.length) : 0,
                    managerStats: Object.entries(managerStats)
                        .map(([id, stats]) => ({ 
                            id, 
                            ...stats,
                            avgChars: Math.round(stats.chars / stats.count)
                        }))
                        .sort((a, b) => b.count - a.count),
                    hourlyStats: hourlyStats
                };
            },
            
            // 통계 카드 업데이트
            updateStatCard(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = typeof value === 'number' ? value.toLocaleString() : value;
                }
            },
            
            // 통계 비교
            compareStats(newStats) {
                if (this.lastStats.totalResponses !== undefined) {
                    this.updateChange('changeNonAssignee', 
                        newStats.totalResponses - this.lastStats.totalResponses);
                    this.updateChange('changeChars', 
                        newStats.totalChars - this.lastStats.totalChars);
                    this.updateChange('changeManagers', 
                        newStats.activeManagers - this.lastStats.activeManagers);
                    this.updateChange('changeResponseTime', 
                        newStats.avgResponseTime - this.lastStats.avgResponseTime);
                    this.updateChange('changeAvgChars', 
                        newStats.avgChars - this.lastStats.avgChars);
                }
            },
            
            // 변화량 표시
            updateChange(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    if (value === 0) {
                        element.textContent = '-';
                        element.className = 'stat-change';
                    } else {
                        const sign = value > 0 ? '+' : '';
                        element.textContent = `${sign}${value}`;
                        element.className = value > 0 ? 'stat-change' : 'stat-change down';
                    }
                }
            },
            
            // 랭킹 업데이트
            updateRanking(managerStats) {
                const tbody = document.getElementById('todayRanking');
                if (!tbody) return;
                
                if (managerStats.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">
                            오늘 비담당 답변 데이터가 없습니다
                        </td></tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = managerStats.slice(0, 10).map((stat, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const rankDisplay = `<span class="rank-number ${rankClass}">${index + 1}</span>`;
                    
                    return `
                        <tr>
                            <td>${rankDisplay}</td>
                            <td>${stat.name}<br><small style="color:#666;">${stat.id}</small></td>
                            <td>${stat.count.toLocaleString()}</td>
                            <td>${stat.chars.toLocaleString()}</td>
                            <td>${stat.avgChars.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            },
            
            // 시간대별 통계 업데이트
            updateHourlyStats(hourlyStats) {
                const tbody = document.getElementById('hourlyStats');
                if (!tbody) return;
                
                const hours = [];
                for (let h = 0; h < 24; h++) {
                    const stat = hourlyStats[h] || { count: 0, chars: 0, managers: new Set() };
                    if (stat.count > 0) {
                        hours.push({
                            hour: h,
                            count: stat.count,
                            managers: stat.managers ? stat.managers.size : 0,
                            avgChars: Math.round(stat.chars / stat.count)
                        });
                    }
                }
                
                if (hours.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#666;">
                            시간대별 데이터가 없습니다
                        </td></tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = hours.map(stat => `
                    <tr>
                        <td>${stat.hour.toString().padStart(2, '0')}:00</td>
                        <td>${stat.count.toLocaleString()}</td>
                        <td>${stat.managers}</td>
                        <td>${stat.avgChars.toLocaleString()}</td>
                    </tr>
                `).join('');
            },
            
            // 실시간 모드 설정
            setupRealtime() {
                // Supabase Realtime 구독
                this.realtimeChannel = supabase
                    .channel('channel-talk-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'channel_non_assignee_responses'
                        },
                        (payload) => {
                            this.handleRealtimeUpdate(payload.new);
                        }
                    )
                    .subscribe((status) => {
                        this.updateRealtimeStatus(status);
                    });
            },
            
            // 실시간 업데이트 처리
            handleRealtimeUpdate(newData) {
                // 새 데이터 추가
                this.currentData.unshift(newData);
                
                // 활동 피드에 추가
                this.addToActivityFeed(newData);
                
                // UI 업데이트
                this.updateUI();
                
                // 알림 표시
                const managerName = newData.manager_name || managerMap[newData.manager_id] || `매니저${newData.manager_id}`;
                this.showNotification(`${managerName}님이 비담당 상담에 답변했습니다`, 'success');
            },
            
            // 활동 피드에 추가
            addToActivityFeed(data) {
                const feed = document.getElementById('activityFeed');
                const managerName = data.manager_name || managerMap[data.manager_id] || `매니저${data.manager_id}`;
                const time = new Date(data.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                const activityHtml = `
                    <div class="activity-item">
                        <div class="activity-time">${time}</div>
                        <div class="activity-text">
                            <span class="activity-counselor">${managerName}</span>님이 
                            <span class="activity-customer">${data.customer_name || '고객'}</span>님의
                            비담당 상담에 답변
                            <span class="activity-chars">(${data.char_count}자)</span>
                        </div>
                    </div>
                `;
                
                // 최대 20개까지만 표시
                this.activityFeed.unshift(activityHtml);
                if (this.activityFeed.length > 20) {
                    this.activityFeed.pop();
                }
                
                feed.innerHTML = this.activityFeed.join('');
                document.getElementById('feedCount').textContent = `${this.activityFeed.length}개 활동`;
            },
            
            // 실시간 상태 업데이트
            updateRealtimeStatus(status) {
                const dot = document.getElementById('realtimeDot');
                const text = document.getElementById('realtimeText');
                
                switch(status) {
                    case 'SUBSCRIBED':
                        dot.className = 'pulse-dot';
                        text.textContent = '실시간 연결됨';
                        break;
                    case 'CHANNEL_ERROR':
                        dot.className = 'pulse-dot disconnected';
                        text.textContent = '연결 오류';
                        break;
                    case 'TIMED_OUT':
                        dot.className = 'pulse-dot disconnected';
                        text.textContent = '연결 시간초과';
                        break;
                    default:
                        dot.className = 'pulse-dot connecting';
                        text.textContent = '연결 중...';
                }
            },
            
            // 채널톡 API 동기화
            async syncChannelTalk() {
                const btn = document.getElementById('syncBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> 동기화 중...';
                
                try {
                    // Vercel API 호출
                    const response = await fetch('/api/channel-sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showNotification(`채널톡 동기화 완료: ${result.processed}개 처리됨`, 'success');
                        await this.loadData();
                    } else {
                        this.showNotification('API 서버를 찾을 수 없습니다', 'error');
                    }
                    
                } catch (error) {
                    console.error('채널톡 동기화 실패:', error);
                    this.showNotification('채널톡 동기화 실패', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '채널톡 동기화';
                }
            },
            
            // 데이터 내보내기
            exportData() {
                if (this.currentData.length === 0) {
                    this.showNotification('내보낼 데이터가 없습니다', 'error');
                    return;
                }
                
                const csv = this.convertToCSV(this.currentData);
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `channel_non_assignee_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('데이터 내보내기 완료', 'success');
            },
            
            // CSV 변환
            convertToCSV(data) {
                const headers = ['시간', '매니저ID', '매니저명', '고객명', '대화ID', '글자수', '응답시간(분)', '도움여부'];
                const rows = data.map(item => [
                    new Date(item.created_at).toLocaleString('ko-KR'),
                    item.manager_id,
                    item.manager_name || managerMap[item.manager_id] || `매니저${item.manager_id}`,
                    item.customer_name || '-',
                    item.user_chat_id,
                    item.char_count,
                    item.response_time || '',
                    item.is_helpful ? 'Y' : 'N'
                ]);
                
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            },
            
            // 상태 표시
            setStatus(type, text) {
                document.getElementById('statusDot').className = 'status-dot ' + type;
                document.getElementById('statusText').textContent = text;
            },
            
            // 알림 표시
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        };
        
        // 앱 시작
        app.init();
    </script>
</body>
</html>
