<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ë„í†¡ ë¹„ë‹´ë‹¹ ìƒë‹´ ì¶”ì  ì‹œìŠ¤í…œ</title>
    
    <!-- Supabase Client ìˆ˜ì •ëœ ë²„ì „ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif; 
            background: #000; 
            color: #fff; 
            min-height: 100vh; 
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 40px 20px; }
        
        /* ë¡œë”© í™”ë©´ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-screen.hide {
            display: none;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #1E6FFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 20px;
            color: #888;
            font-size: 14px;
        }
        
        /* í—¤ë” */
        .header { 
            text-align: center; 
            margin-bottom: 50px;
            padding: 30px;
            background: #000;
            border: 1px solid #222;
        }
        .header h1 { 
            font-size: 52px; 
            font-weight: 200; 
            margin-bottom: 15px;
        }
        .header h1 span { 
            color: #1E6FFF; 
            font-weight: 400;
        }
        .subtitle { 
            color: #999; 
            font-size: 16px; 
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        .date-display { 
            color: #888; 
            font-size: 15px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin-top: 20px;
        }
        
        /* ì»¨íŠ¸ë¡¤ ë°” */
        .control-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px 30px; 
            background: #000; 
            border: 1px solid #222;
            margin-bottom: 40px; 
            flex-wrap: wrap; 
            gap: 20px;
        }
        .control-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .btn { 
            padding: 12px 30px; 
            background: transparent; 
            color: #999; 
            border: 1px solid #333; 
            font-size: 15px; 
            font-weight: 500; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .btn:hover { 
            color: #1E6FFF; 
            border-color: #1E6FFF;
        }
        .btn.primary { 
            color: #1E6FFF; 
            border-color: #1E6FFF;
        }
        .btn.primary:hover { 
            background: #1E6FFF; 
            color: #000;
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 2px; 
            margin-bottom: 50px;
            background: #111;
            padding: 2px;
        }
        .stat-card { 
            background: #000; 
            padding: 35px; 
            text-align: center; 
            position: relative; 
            overflow: hidden;
        }
        .stat-card:hover {
            background: #050505;
        }
        .stat-icon {
            font-size: 36px;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        .stat-value { 
            font-size: 52px; 
            font-weight: 200; 
            color: #1E6FFF; 
            margin-bottom: 12px;
            font-variant-numeric: tabular-nums;
        }
        .stat-label { 
            font-size: 14px; 
            color: #888; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-weight: 400;
        }
        
        /* í…Œì´ë¸” */
        .table-container {
            background: #000;
            border: 1px solid #222;
            margin-bottom: 40px;
        }
        .table-header {
            padding: 25px 30px;
            border-bottom: 1px solid #222;
        }
        .table-title {
            font-size: 17px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #1E6FFF;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            padding: 20px;
            text-align: left;
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #222;
            font-weight: 500;
        }
        td {
            padding: 20px;
            font-size: 16px;
            border-bottom: 1px solid #111;
            color: #ccc;
        }
        tr:hover {
            background: #050505;
        }
        
        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-container {
            background: #111;
            border: 1px solid #FF4444;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        .error-title {
            color: #FF4444;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .error-message {
            color: #999;
            font-size: 14px;
            line-height: 1.6;
        }
        .error-code {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            color: #888;
            text-align: left;
            overflow-x: auto;
        }
        
        /* ì•Œë¦¼ */
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 18px 25px; 
            background: #111;
            border: 1px solid #1E6FFF;
            color: #fff; 
            font-size: 15px;
            font-weight: 500;
            z-index: 1000; 
            animation: slideIn 0.3s; 
            display: none;
        }
        .notification.show { display: block; }
        .notification.error { border-color: #FF0000; }
        .notification.success { border-color: #00FF00; }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        @keyframes slideIn { 
            from { transform: translateX(100%); } 
            to { transform: translateX(0); } 
        }
        
        /* ëª¨ë°”ì¼ */
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 36px; }
            .stat-value { font-size: 42px; }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...</div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ì±„ë„í†¡ <span>ë¹„ë‹´ë‹¹ ìƒë‹´ ì¶”ì </span></h1>
            <div class="subtitle">ë‹´ë‹¹ì(ASSIGNEE)ê°€ ì•„ë‹Œ ë§¤ë‹ˆì €ì˜ ë‹µë³€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤</div>
            <div class="date-display" id="dateDisplay"></div>
        </div>
        
        <!-- ì—ëŸ¬ ì»¨í…Œì´ë„ˆ (ìˆ¨ê¹€) -->
        <div class="error-container" id="errorContainer" style="display:none;">
            <div class="error-title">âš ï¸ ì—°ê²° ì˜¤ë¥˜</div>
            <div class="error-message" id="errorMessage">Supabase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
            <div class="error-code" id="errorCode"></div>
            <button class="btn primary" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ ë°” -->
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="App.loadData()" id="refreshBtn">
                    ìƒˆë¡œê³ ì¹¨
                </button>
                <button class="btn" onclick="App.generateTestData()" id="testBtn">
                    í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                </button>
                <button class="btn" onclick="App.exportData()" id="exportBtn">
                    CSV ë‚´ë³´ë‚´ê¸°
                </button>
                <button class="btn" onclick="App.createTable()" id="createTableBtn">
                    í…Œì´ë¸” ìƒì„±
                </button>
            </div>
            <div class="status-indicator">
                <span id="statusText" style="color: #888;">ëŒ€ê¸° ì¤‘</span>
                <span id="lastUpdate" style="margin-left: 20px; color: #888;"></span>
            </div>
        </div>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-value" id="totalResponses">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ë¹„ë‹´ë‹¹ ë‹µë³€</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœï¸</div>
                <div class="stat-value" id="totalChars">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì´ ê¸€ììˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="activeManagers">0</div>
                <div class="stat-label">í™œë™ ë§¤ë‹ˆì €</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-value" id="avgChars">0</div>
                <div class="stat-label">í‰ê·  ê¸€ììˆ˜</div>
            </div>
        </div>
        
        <!-- ë­í‚¹ í…Œì´ë¸” -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">ì˜¤ëŠ˜ì˜ ë¹„ë‹´ë‹¹ ë„ì›€ ë­í‚¹</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="80">ìˆœìœ„</th>
                        <th>ë§¤ë‹ˆì €</th>
                        <th width="100">íšŸìˆ˜</th>
                        <th width="120">ê¸€ììˆ˜</th>
                        <th width="120">í‰ê· </th>
                    </tr>
                </thead>
                <tbody id="rankingTable">
                    <tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ì•Œë¦¼ -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Supabase ê¸€ë¡œë²Œ ë³€ìˆ˜
        let supabase = null;
        
        // App ê°ì²´
        const App = {
            currentData: [],
            
            // ë§¤ë‹ˆì € ë§¤í•‘
            managerMap: {
                '520798': 'ì±„ì£¼ì€', '520799': 'ìœ¤ë„ìš°ë¦¬', '521212': 'ì†ì§„ìš°',
                '521213': 'ì°¨ì •í™˜', '521214': 'ì„œë¯¼êµ­', '521215': 'êµ¬ë³¸ì˜',
                '521217': 'ê¶Œì¬í˜„', '521218': 'ì¡°ì‹œí˜„', '521220': 'ê¹€ìƒì•„',
                '521221': 'ê¹€ì§€ì›', '521222': 'ì •ë‹¤í˜œ', '521223': 'ê¹€ì‹œì§„',
                '521224': 'ì‹ í˜œì„œ', '521226': 'ì´ë¯¼ì£¼', '521227': 'ì •ì£¼ì—°',
                '521230': 'ê¹€ì§„í›„', '521231': 'ì´í˜œì˜', '521232': 'ê¹€ì˜ì§„',
                '521233': 'ìµœí˜¸ìµ', '521234': 'ì„œì •êµ­', '521236': 'ë°•í•´ì˜',
                '521239': 'ì´ì¢…ë¯¼', '521243': 'ê°•í˜•ìš±', '521378': 'ì˜¤ë¯¼ê²½',
                '521379': 'ìµœìˆ˜ëŠ¥', '521381': 'ê¹€ì±„ì˜', '521382': 'ì „ì§€ìœ¤',
                '521383': 'ì´ìœ ì£¼', '521384': 'ê¹€ë²”ì£¼', '521385': 'ê¹€ì˜ˆì§„',
                '521386': 'ì°¨ìŠ¹í˜„', '521392': 'ì´ì„±ì² ', '521393': 'ë°•ì€ì§„',
                '521410': 'ì˜¤ë¯¼í™˜', '521416': 'ì „ë¯¸ë€', '521564': 'ê¹€êµ­í˜„',
                '521567': 'ê¹€ì„±í˜„', '521902': 'ê¹€ì‹œìœ¤', '521937': 'ê¹€ì¢…í˜„',
                '521942': 'ì£¼ì€ì§€', '521965': 'ê°•í—Œì¤€', '522038': 'ë¬¸í™ì£¼',
                '523260': 'ì£¼ìˆ˜í˜„', '523268': 'ì˜¤í˜„ìˆ˜', '527833': 'ìœ ì¢…í˜„',
                '527836': 'ê¹€ì§„í˜‘', '527910': 'ì˜¥ì„œì•„', '528425': 'ì •ìš©ìš±',
                '528628': 'ê¹€ì†Œì˜', '529149': 'ë™ìˆ˜ì§„', '529561': 'í•œìŠ¹ìœ¤',
                '544751': 'ì„±ì¼í›ˆ', '555633': 'ì•„ì •ë‹¹', '555865': 'ê³µí˜„ì¤€'
            },
            
            // ì´ˆê¸°í™”
            async init() {
                console.log('ì•± ì´ˆê¸°í™” ì‹œì‘...');
                
                try {
                    // Supabase ì´ˆê¸°í™”
                    const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
                    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
                    
                    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                    if (window.supabase && window.supabase.createClient) {
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì„±ê³µ');
                    } else {
                        throw new Error('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    }
                    
                    // ë‚ ì§œ í‘œì‹œ
                    this.updateDateTime();
                    setInterval(() => this.updateDateTime(), 60000);
                    
                    // ë°ì´í„° ë¡œë“œ
                    await this.loadData();
                    
                    // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                    document.getElementById('loadingScreen').classList.add('hide');
                    
                } catch (error) {
                    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showError(error);
                    document.getElementById('loadingScreen').classList.add('hide');
                }
            },
            
            // ë‚ ì§œì‹œê°„ ì—…ë°ì´íŠ¸
            updateDateTime() {
                const now = new Date();
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                document.getElementById('dateDisplay').textContent = 
                    `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${days[now.getDay()]}ìš”ì¼`;
                document.getElementById('lastUpdate').textContent = 
                    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            },
            
            // ë°ì´í„° ë¡œë“œ
            async loadData() {
                if (!supabase) {
                    this.showError(new Error('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
                    return;
                }
                
                const btn = document.getElementById('refreshBtn');
                btn.disabled = true;
                document.getElementById('statusText').textContent = 'ë°ì´í„° ë¡œë“œ ì¤‘...';
                
                try {
                    const today = new Date();
                    const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
                    const endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString();
                    
                    const { data, error } = await supabase
                        .from('channel_non_assignee_responses')
                        .select('*')
                        .gte('created_at', startDate)
                        .lt('created_at', endDate)
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('Supabase ì—ëŸ¬:', error);
                        if (error.message.includes('relation') || error.message.includes('does not exist')) {
                            this.showNotification('í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. "í…Œì´ë¸” ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'error');
                        } else {
                            throw error;
                        }
                        return;
                    }
                    
                    this.currentData = data || [];
                    this.updateUI();
                    this.updateDateTime();
                    document.getElementById('statusText').textContent = 'ì—…ë°ì´íŠ¸ ì™„ë£Œ';
                    
                } catch (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('statusText').textContent = 'ë¡œë“œ ì‹¤íŒ¨';
                    this.showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                }
            },
            
            // í…Œì´ë¸” ìƒì„±
            async createTable() {
                if (!supabase) {
                    this.showError(new Error('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
                    return;
                }
                
                const btn = document.getElementById('createTableBtn');
                btn.disabled = true;
                
                try {
                    // SQL Editorì—ì„œ ì‹¤í–‰í•  ì¿¼ë¦¬
                    const tableSQL = `
                        CREATE TABLE IF NOT EXISTS channel_non_assignee_responses (
                            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                            manager_id TEXT,
                            manager_name TEXT,
                            user_chat_id TEXT,
                            assignee_id TEXT,
                            customer_name TEXT,
                            message_content TEXT,
                            char_count INTEGER DEFAULT 0,
                            response_time INTEGER,
                            is_helpful BOOLEAN DEFAULT false,
                            created_at TIMESTAMPTZ DEFAULT NOW()
                        );
                    `;
                    
                    this.showNotification('í…Œì´ë¸” ìƒì„±ì€ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì§ì ‘ í•´ì£¼ì„¸ìš”', 'error');
                    window.open('https://supabase.com/dashboard/project/bhtqjipygkawoyieidgp/sql', '_blank');
                    
                } catch (error) {
                    console.error('í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨:', error);
                    this.showNotification('í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨', 'error');
                } finally {
                    btn.disabled = false;
                }
            },
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
            async generateTestData() {
                if (!supabase) {
                    this.showError(new Error('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
                    return;
                }
                
                const btn = document.getElementById('testBtn');
                btn.disabled = true;
                document.getElementById('statusText').textContent = 'í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì¤‘...';
                
                try {
                    const managers = Object.entries(this.managerMap).slice(0, 10);
                    const customers = ['ê¹€ê³ ê°', 'ì´ê³ ê°', 'ë°•ê³ ê°', 'ìµœê³ ê°', 'ì •ê³ ê°'];
                    
                    const testData = [];
                    for (let i = 0; i < 10; i++) {
                        const [managerId, managerName] = managers[Math.floor(Math.random() * managers.length)];
                        const [assigneeId] = managers[Math.floor(Math.random() * managers.length)];
                        
                        if (managerId !== assigneeId) {
                            const charCount = Math.floor(Math.random() * 500) + 100;
                            testData.push({
                                manager_id: managerId,
                                manager_name: managerName,
                                user_chat_id: `chat_${Date.now()}_${i}`,
                                assignee_id: assigneeId,
                                customer_name: customers[Math.floor(Math.random() * customers.length)],
                                message_content: 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.',
                                char_count: charCount,
                                response_time: Math.floor(Math.random() * 10) + 1,
                                is_helpful: Math.random() > 0.3
                            });
                        }
                    }
                    
                    const { error } = await supabase
                        .from('channel_non_assignee_responses')
                        .insert(testData);
                    
                    if (error) throw error;
                    
                    await this.loadData();
                    this.showNotification(`${testData.length}ê°œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ`, 'success');
                    
                } catch (error) {
                    console.error('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', error);
                    this.showNotification('ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                }
            },
            
            // UI ì—…ë°ì´íŠ¸
            updateUI() {
                const stats = this.calculateStats();
                
                // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('totalResponses').textContent = stats.totalResponses.toLocaleString();
                document.getElementById('totalChars').textContent = stats.totalChars.toLocaleString();
                document.getElementById('activeManagers').textContent = stats.activeManagers;
                document.getElementById('avgChars').textContent = stats.avgChars.toLocaleString();
                
                // ë­í‚¹ ì—…ë°ì´íŠ¸
                this.updateRanking(stats.managerStats);
            },
            
            // í†µê³„ ê³„ì‚°
            calculateStats() {
                const managerStats = {};
                let totalChars = 0;
                
                this.currentData.forEach(item => {
                    const managerId = item.manager_id;
                    const managerName = item.manager_name || this.managerMap[managerId] || `ë§¤ë‹ˆì €${managerId}`;
                    
                    if (!managerStats[managerId]) {
                        managerStats[managerId] = {
                            name: managerName,
                            count: 0,
                            chars: 0
                        };
                    }
                    managerStats[managerId].count++;
                    managerStats[managerId].chars += item.char_count || 0;
                    totalChars += item.char_count || 0;
                });
                
                return {
                    totalResponses: this.currentData.length,
                    totalChars: totalChars,
                    activeManagers: Object.keys(managerStats).length,
                    avgChars: this.currentData.length > 0 ? Math.round(totalChars / this.currentData.length) : 0,
                    managerStats: Object.entries(managerStats)
                        .map(([id, stats]) => ({ 
                            id, 
                            ...stats,
                            avgChars: Math.round(stats.chars / stats.count)
                        }))
                        .sort((a, b) => b.count - a.count)
                };
            },
            
            // ë­í‚¹ ì—…ë°ì´íŠ¸
            updateRanking(managerStats) {
                const tbody = document.getElementById('rankingTable');
                if (!tbody) return;
                
                if (managerStats.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">
                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = managerStats.slice(0, 10).map((stat, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${stat.name}<br><small style="color:#666;">${stat.id}</small></td>
                        <td>${stat.count.toLocaleString()}</td>
                        <td>${stat.chars.toLocaleString()}</td>
                        <td>${stat.avgChars.toLocaleString()}</td>
                    </tr>
                `).join('');
            },
            
            // CSV ë‚´ë³´ë‚´ê¸°
            exportData() {
                if (this.currentData.length === 0) {
                    this.showNotification('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const headers = ['ì‹œê°„', 'ë§¤ë‹ˆì €ID', 'ë§¤ë‹ˆì €ëª…', 'ê³ ê°ëª…', 'ëŒ€í™”ID', 'ê¸€ììˆ˜'];
                const rows = this.currentData.map(item => [
                    new Date(item.created_at).toLocaleString('ko-KR'),
                    item.manager_id,
                    item.manager_name || this.managerMap[item.manager_id] || '',
                    item.customer_name || '',
                    item.user_chat_id,
                    item.char_count
                ]);
                
                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `channel_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.click();
                
                this.showNotification('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
            },
            
            // ì—ëŸ¬ í‘œì‹œ
            showError(error) {
                const container = document.getElementById('errorContainer');
                const message = document.getElementById('errorMessage');
                const code = document.getElementById('errorCode');
                
                container.style.display = 'block';
                message.textContent = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                code.textContent = error.stack || '';
            },
            
            // ì•Œë¦¼ í‘œì‹œ
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            // Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸°
            setTimeout(() => {
                if (window.supabase) {
                    App.init();
                } else {
                    document.getElementById('loadingScreen').classList.add('hide');
                    App.showError(new Error('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.'));
                }
            }, 1000);
        });
    </script>
</body>
</html>
