<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ë„í†¡ ë¹„ë‹´ë‹¹ ìƒë‹´ ë„ì›€ ì¶”ì  ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; 
            min-height: 100vh; 
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 40px 20px; }
        
        /* ì±„ë„í†¡ ìŠ¤íƒ€ì¼ í—¤ë” */
        .header { 
            text-align: center; 
            margin-bottom: 50px; 
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .header h1 { 
            font-size: 48px; 
            font-weight: 300; 
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .header h1 span { 
            font-weight: 700; 
            background: linear-gradient(45deg, #FFE000, #FFA000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { 
            color: rgba(255,255,255,0.9); 
            font-size: 18px; 
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        .channel-badge {
            display: inline-block;
            background: #5856D6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 15px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ */
        .realtime-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        .pulse-dot.disconnected { background: #F44336; }
        .pulse-dot.connecting { background: #FF9800; }
        
        /* ì»¨íŠ¸ë¡¤ ë°” */
        .control-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px;
            margin-bottom: 40px; 
            flex-wrap: wrap; 
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        .control-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .btn { 
            padding: 12px 30px; 
            background: rgba(255,255,255,0.2); 
            color: #fff; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 10px;
            font-size: 14px; 
            font-weight: 600; 
            letter-spacing: 0.5px; 
            cursor: pointer; 
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .btn:hover { 
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .btn.primary { 
            background: linear-gradient(45deg, #5856D6, #7C3AED);
            border: none;
        }
        .btn.primary:hover { 
            background: linear-gradient(45deg, #4744C9, #6B2FE0);
            box-shadow: 0 5px 30px rgba(88,86,214,0.5);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 50px;
        }
        .stat-card { 
            background: rgba(255,255,255,0.95); 
            color: #333;
            border-radius: 15px;
            padding: 30px; 
            text-align: center; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #5856D6, #7C3AED);
        }
        .stat-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }
        .stat-value { 
            font-size: 42px; 
            font-weight: 700; 
            background: linear-gradient(45deg, #5856D6, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
        }
        .stat-label { 
            font-size: 14px; 
            color: #666; 
            font-weight: 500;
        }
        .stat-change {
            font-size: 14px;
            color: #4CAF50;
            margin-top: 10px;
            font-weight: 600;
        }
        .stat-change.down { color: #F44336; }
        
        /* ì‹¤ì‹œê°„ í™œë™ í”¼ë“œ */
        .activity-feed {
            background: rgba(255,255,255,0.95);
            color: #333;
            border-radius: 15px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-height: 450px;
            overflow: hidden;
        }
        .feed-header {
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .feed-title {
            font-size: 18px;
            font-weight: 600;
        }
        .feed-content {
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
            background: white;
        }
        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            animation: slideIn 0.3s;
            transition: all 0.2s;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .activity-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }
        .activity-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        .activity-text {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        .activity-counselor {
            color: #5856D6;
            font-weight: 700;
        }
        .activity-customer {
            background: #FFE000;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .activity-chars {
            color: #999;
            font-size: 12px;
            margin-left: 10px;
        }
        
        /* ë­í‚¹ í…Œì´ë¸” */
        .ranking-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        @media (max-width: 1024px) {
            .ranking-section { grid-template-columns: 1fr; }
        }
        
        .ranking-table { 
            background: rgba(255,255,255,0.95);
            color: #333;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table-header { 
            padding: 25px 30px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .table-title { 
            font-size: 18px; 
            font-weight: 600;
        }
        table { 
            width: 100%; 
            border-collapse: collapse;
            background: white;
        }
        th { 
            padding: 20px; 
            text-align: left; 
            font-size: 12px; 
            color: #666; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            border-bottom: 2px solid #f0f0f0;
            font-weight: 600;
        }
        td { 
            padding: 20px; 
            font-size: 15px; 
            border-bottom: 1px solid #f0f0f0;
            font-variant-numeric: tabular-nums;
            color: #333;
        }
        tr:hover { 
            background: #f8f9fa;
        }
        .rank-badge {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: #fff; }
        .rank-2 { background: linear-gradient(45deg, #C0C0C0, #808080); color: #fff; }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #8B4513); color: #fff; }
        
        /* ì±„ë„í†¡ ìŠ¤íƒ€ì¼ ì•Œë¦¼ */
        .notification { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            padding: 20px 25px; 
            background: white;
            border-radius: 12px;
            color: #333; 
            font-size: 14px; 
            font-weight: 600;
            z-index: 1000; 
            animation: slideUp 0.3s; 
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-left: 4px solid #5856D6;
        }
        .notification.show { display: block; }
        .notification.error { 
            border-left-color: #F44336;
        }
        .notification.success {
            border-left-color: #4CAF50;
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes slideIn { 
            from { 
                opacity: 0;
                transform: translateX(-20px); 
            } 
            to { 
                opacity: 1;
                transform: translateX(0); 
            } 
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { 
            background: #5856D6; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #4744C9; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ -->
        <div class="realtime-status">
            <div class="realtime-indicator">
                <span class="pulse-dot" id="realtimeDot"></span>
                <span id="realtimeText" style="color: #333; font-weight: 600;">ì—°ê²° ëŒ€ê¸°ì¤‘</span>
            </div>
        </div>

        <!-- í—¤ë” -->
        <div class="header">
            <h1>ì±„ë„í†¡ <span>ë¹„ë‹´ë‹¹ ìƒë‹´ ë„ì›€ ì¶”ì </span></h1>
            <div class="subtitle">ë‹´ë‹¹ì(assignee)ê°€ ì•„ë‹Œ ë§¤ë‹ˆì €ì˜ ë‹µë³€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤</div>
            <div class="channel-badge">CHANNEL TALK INTEGRATION</div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ ë°” -->
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="app.loadData()" id="refreshBtn">
                    <span id="refreshIcon">â†»</span> ìƒˆë¡œê³ ì¹¨
                </button>
                <button class="btn" onclick="app.syncChannelTalk()" id="syncBtn">
                    ì±„ë„í†¡ ë™ê¸°í™”
                </button>
                <button class="btn" onclick="app.exportData()" id="exportBtn">
                    ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                </button>
                <button class="btn" onclick="app.toggleRealtime()" id="realtimeBtn">
                    âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ
                </button>
            </div>
            <div style="color: rgba(255,255,255,0.9); font-size: 14px;">
                <span id="lastUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
            </div>
        </div>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-value" id="totalNonAssignee">0</div>
                <div class="stat-label">ë¹„ë‹´ë‹¹ ë‹µë³€ ìˆ˜</div>
                <div class="stat-change" id="changeNonAssignee">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-value" id="totalChars">0</div>
                <div class="stat-label">ì´ ê¸€ììˆ˜</div>
                <div class="stat-change" id="changeChars">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="activeManagers">0</div>
                <div class="stat-label">í™œë™ ë§¤ë‹ˆì €</div>
                <div class="stat-change" id="changeManagers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-value" id="avgResponseTime">0</div>
                <div class="stat-label">í‰ê·  ì‘ë‹µì‹œê°„(ë¶„)</div>
                <div class="stat-change" id="changeResponseTime">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-value" id="helpRate">0%</div>
                <div class="stat-label">ë„ì›€ ë¹„ìœ¨</div>
                <div class="stat-change" id="changeHelpRate">-</div>
            </div>
        </div>
        
        <!-- ì‹¤ì‹œê°„ í™œë™ í”¼ë“œ -->
        <div class="activity-feed">
            <div class="feed-header">
                <div class="feed-title">âš¡ ì‹¤ì‹œê°„ í™œë™</div>
                <span id="feedCount">0ê°œ í™œë™</span>
            </div>
            <div class="feed-content" id="activityFeed">
                <div style="padding: 50px; text-align: center; color: #999;">
                    ì±„ë„í†¡ í™œë™ì´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤
                </div>
            </div>
        </div>
        
        <!-- ë­í‚¹ í…Œì´ë¸” -->
        <div class="ranking-section">
            <!-- ì˜¤ëŠ˜ì˜ ë§¤ë‹ˆì € ë­í‚¹ -->
            <div class="ranking-table">
                <div class="table-header">
                    <div class="table-title">ğŸ† ì˜¤ëŠ˜ì˜ ë¹„ë‹´ë‹¹ ë„ì›€ ë­í‚¹</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th width="60">ìˆœìœ„</th>
                            <th>ë§¤ë‹ˆì €</th>
                            <th width="80">íšŸìˆ˜</th>
                            <th width="100">ê¸€ììˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="todayRanking">
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#999;">
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ì‹œê°„ëŒ€ë³„ í†µê³„ -->
            <div class="ranking-table">
                <div class="table-header">
                    <div class="table-title">ğŸ“Š ì‹œê°„ëŒ€ë³„ í™œë™ í†µê³„</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ì‹œê°„ëŒ€</th>
                            <th>ë‹µë³€ ìˆ˜</th>
                            <th>í™œë™ ë§¤ë‹ˆì €</th>
                            <th>í‰ê·  ê¸€ì</th>
                        </tr>
                    </thead>
                    <tbody id="hourlyStats">
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#999;">
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // âœ… Supabase ì„¤ì • (í‚¤ ìë™ ì ìš© ì™„ë£Œ!)
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd285aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ì±„ë„í†¡ ë§¤ë‹ˆì €(ìƒë‹´ì‚¬) ë§¤í•‘
        const managerMap = {
            '520798': 'ì±„ì£¼ì€', '520799': 'ìœ¤ë„ìš°ë¦¬', '521212': 'ì†ì§„ìš°',
            '521213': 'ì°¨ì •í™˜', '521214': 'ì„œë¯¼êµ­', '521215': 'êµ¬ë³¸ì˜',
            '521217': 'ê¶Œì¬í˜„', '521218': 'ì¡°ì‹œí˜„', '521220': 'ê¹€ìƒì•„',
            '521221': 'ê¹€ì§€ì›', '521222': 'ì •ë‹¤í˜œ', '521223': 'ê¹€ì‹œì§„',
            '521224': 'ì‹ í˜œì„œ', '521226': 'ì´ë¯¼ì£¼', '521227': 'ì •ì£¼ì—°',
            '521230': 'ê¹€ì§„í›„', '521231': 'ì´í˜œì˜', '521232': 'ê¹€ì˜ì§„',
            '521233': 'ìµœí˜¸ìµ', '521234': 'ì„œì •êµ­', '521236': 'ë°•í•´ì˜',
            '521239': 'ì´ì¢…ë¯¼', '521243': 'ê°•í˜•ìš±', '521378': 'ì˜¤ë¯¼ê²½',
            '521379': 'ìµœìˆ˜ëŠ¥', '521381': 'ê¹€ì±„ì˜', '521382': 'ì „ì§€ìœ¤',
            '521383': 'ì´ìœ ì£¼', '521384': 'ê¹€ë²”ì£¼', '521385': 'ê¹€ì˜ˆì§„',
            '521386': 'ì°¨ìŠ¹í˜„', '521392': 'ì´ì„±ì² ', '521393': 'ë°•ì€ì§„',
            '521410': 'ì˜¤ë¯¼í™˜', '521416': 'ì „ë¯¸ë€', '521564': 'ê¹€êµ­í˜„',
            '521567': 'ê¹€ì„±í˜„', '521902': 'ê¹€ì‹œìœ¤', '521937': 'ê¹€ì¢…í˜„',
            '521942': 'ì£¼ì€ì§€', '521965': 'ê°•í—Œì¤€', '522038': 'ë¬¸í™ì£¼',
            '523260': 'ì£¼ìˆ˜í˜„', '523268': 'ì˜¤í˜„ìˆ˜', '527833': 'ìœ ì¢…í˜„',
            '527836': 'ê¹€ì§„í˜‘', '527910': 'ì˜¥ì„œì•„', '528425': 'ì •ìš©ìš±',
            '528628': 'ê¹€ì†Œì˜', '529149': 'ë™ìˆ˜ì§„', '529561': 'í•œìŠ¹ìœ¤',
            '544751': 'ì„±ì¼í›ˆ', '555633': 'ì•„ì •ë‹¹', '555865': 'ê³µí˜„ì¤€'
        };
        
        // ì•± ìƒíƒœ ê´€ë¦¬
        const app = {
            currentData: [],
            realtimeChannel: null,
            activityFeed: [],
            lastStats: {},
            
            // ì´ˆê¸°í™”
            async init() {
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 60000);
                
                await this.loadData();
                this.setupRealtime();
                
                // ìë™ ìƒˆë¡œê³ ì¹¨ (3ë¶„ë§ˆë‹¤)
                setInterval(() => this.loadData(), 180000);
            },
            
            // ë‚ ì§œì‹œê°„ ì—…ë°ì´íŠ¸
            updateDateTime() {
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                document.getElementById('lastUpdate').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeStr}`;
            },
            
            // ë°ì´í„° ë¡œë“œ
            async loadData() {
                const btn = document.getElementById('refreshBtn');
                const icon = document.getElementById('refreshIcon');
                btn.disabled = true;
                icon.style.animation = 'spin 1s linear infinite';
                
                try {
                    // ì˜¤ëŠ˜ ë‚ ì§œ
                    const today = new Date();
                    const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
                    const endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString();
                    
                    // ë¹„ë‹´ë‹¹ ë‹µë³€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const { data: responses, error } = await supabase
                        .from('channel_non_assignee_responses')
                        .select('*')
                        .gte('created_at', startDate)
                        .lt('created_at', endDate)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    this.currentData = responses || [];
                    this.updateUI();
                    this.updateDateTime();
                    this.showNotification('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
                    
                } catch (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
                } finally {
                    btn.disabled = false;
                    icon.style.animation = '';
                }
            },
            
            // UI ì—…ë°ì´íŠ¸
            updateUI() {
                // í†µê³„ ê³„ì‚°
                const stats = this.calculateStats();
                
                // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                this.updateStatCard('totalNonAssignee', stats.totalResponses);
                this.updateStatCard('totalChars', stats.totalChars);
                this.updateStatCard('activeManagers', stats.activeManagers);
                this.updateStatCard('avgResponseTime', stats.avgResponseTime);
                this.updateStatCard('helpRate', stats.helpRate + '%');
                
                // ë­í‚¹ ì—…ë°ì´íŠ¸
                this.updateRanking(stats.managerStats);
                
                // ì‹œê°„ëŒ€ë³„ í†µê³„ ì—…ë°ì´íŠ¸
                this.updateHourlyStats(stats.hourlyStats);
                
                // ì´ì „ í†µê³„ì™€ ë¹„êµ
                this.compareStats(stats);
                this.lastStats = stats;
            },
            
            // í†µê³„ ê³„ì‚°
            calculateStats() {
                const managerStats = {};
                const hourlyStats = {};
                let totalChars = 0;
                let totalResponseTime = 0;
                let responseCount = 0;
                
                this.currentData.forEach(item => {
                    // ë§¤ë‹ˆì €ë³„ í†µê³„
                    const managerId = item.manager_id;
                    const managerName = item.manager_name || managerMap[managerId] || `ë§¤ë‹ˆì €${managerId}`;
                    
                    if (!managerStats[managerId]) {
                        managerStats[managerId] = {
                            name: managerName,
                            count: 0,
                            chars: 0
                        };
                    }
                    managerStats[managerId].count++;
                    managerStats[managerId].chars += item.char_count || 0;
                    
                    // ì‹œê°„ëŒ€ë³„ í†µê³„
                    const hour = new Date(item.created_at).getHours();
                    if (!hourlyStats[hour]) {
                        hourlyStats[hour] = {
                            count: 0,
                            chars: 0,
                            managers: new Set()
                        };
                    }
                    hourlyStats[hour].count++;
                    hourlyStats[hour].chars += item.char_count || 0;
                    hourlyStats[hour].managers.add(managerId);
                    
                    // ì „ì²´ í†µê³„
                    totalChars += item.char_count || 0;
                    
                    if (item.response_time) {
                        totalResponseTime += item.response_time;
                        responseCount++;
                    }
                });
                
                return {
                    totalResponses: this.currentData.length,
                    totalChars: totalChars,
                    activeManagers: Object.keys(managerStats).length,
                    avgResponseTime: responseCount > 0 ? Math.round(totalResponseTime / responseCount) : 0,
                    helpRate: this.currentData.length > 0 ? 
                        Math.round((this.currentData.filter(d => d.is_helpful).length / this.currentData.length) * 100) : 0,
                    managerStats: Object.entries(managerStats)
                        .map(([id, stats]) => ({ id, ...stats }))
                        .sort((a, b) => b.count - a.count),
                    hourlyStats: hourlyStats
                };
            },
            
            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateStatCard(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = typeof value === 'number' ? value.toLocaleString() : value;
                }
            },
            
            // í†µê³„ ë¹„êµ
            compareStats(newStats) {
                if (this.lastStats.totalResponses !== undefined) {
                    this.updateChange('changeNonAssignee', 
                        newStats.totalResponses - this.lastStats.totalResponses);
                    this.updateChange('changeChars', 
                        newStats.totalChars - this.lastStats.totalChars);
                    this.updateChange('changeManagers', 
                        newStats.activeManagers - this.lastStats.activeManagers);
                    this.updateChange('changeResponseTime', 
                        newStats.avgResponseTime - this.lastStats.avgResponseTime);
                    this.updateChange('changeHelpRate', 
                        newStats.helpRate - this.lastStats.helpRate, '%');
                }
            },
            
            // ë³€í™”ëŸ‰ í‘œì‹œ
            updateChange(id, value, suffix = '') {
                const element = document.getElementById(id);
                if (element && value !== 0) {
                    const sign = value > 0 ? 'â†‘' : 'â†“';
                    element.textContent = `${sign} ${Math.abs(value)}${suffix}`;
                    element.className = value > 0 ? 'stat-change' : 'stat-change down';
                }
            },
            
            // ë­í‚¹ ì—…ë°ì´íŠ¸
            updateRanking(managerStats) {
                const tbody = document.getElementById('todayRanking');
                if (!tbody) return;
                
                if (managerStats.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#999;">
                            ì˜¤ëŠ˜ ë¹„ë‹´ë‹¹ ë‹µë³€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                        </td></tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = managerStats.slice(0, 10).map((stat, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const rankDisplay = index < 3 ? 
                        `<span class="rank-badge ${rankClass}">${index + 1}</span>` : 
                        `${index + 1}`;
                    
                    return `
                        <tr>
                            <td>${rankDisplay}</td>
                            <td>${stat.name}</td>
                            <td>${stat.count}</td>
                            <td>${stat.chars.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            },
            
            // ì‹œê°„ëŒ€ë³„ í†µê³„ ì—…ë°ì´íŠ¸
            updateHourlyStats(hourlyStats) {
                const tbody = document.getElementById('hourlyStats');
                if (!tbody) return;
                
                const hours = [];
                for (let h = 0; h < 24; h++) {
                    const stat = hourlyStats[h] || { count: 0, chars: 0, managers: new Set() };
                    if (stat.count > 0) {
                        hours.push({
                            hour: h,
                            count: stat.count,
                            managers: stat.managers ? stat.managers.size : 0,
                            avgChars: Math.round(stat.chars / stat.count)
                        });
                    }
                }
                
                if (hours.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="4" style="text-align:center;padding:50px;color:#999;">
                            ì‹œê°„ëŒ€ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                        </td></tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = hours.map(stat => `
                    <tr>
                        <td>${stat.hour.toString().padStart(2, '0')}:00</td>
                        <td>${stat.count}</td>
                        <td>${stat.managers}</td>
                        <td>${stat.avgChars.toLocaleString()}</td>
                    </tr>
                `).join('');
            },
            
            // ì‹¤ì‹œê°„ ëª¨ë“œ ì„¤ì •
            setupRealtime() {
                // Supabase Realtime êµ¬ë…
                this.realtimeChannel = supabase
                    .channel('channel-talk-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'channel_non_assignee_responses'
                        },
                        (payload) => {
                            this.handleRealtimeUpdate(payload.new);
                        }
                    )
                    .subscribe((status) => {
                        this.updateRealtimeStatus(status);
                    });
            },
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
            handleRealtimeUpdate(newData) {
                // ìƒˆ ë°ì´í„° ì¶”ê°€
                this.currentData.unshift(newData);
                
                // í™œë™ í”¼ë“œì— ì¶”ê°€
                this.addToActivityFeed(newData);
                
                // UI ì—…ë°ì´íŠ¸
                this.updateUI();
                
                // ì•Œë¦¼ í‘œì‹œ
                const managerName = newData.manager_name || managerMap[newData.manager_id] || `ë§¤ë‹ˆì €${newData.manager_id}`;
                this.showNotification(`${managerName}ë‹˜ì´ ë¹„ë‹´ë‹¹ ìƒë‹´ì— ë‹µë³€í–ˆìŠµë‹ˆë‹¤`, 'success');
            },
            
            // í™œë™ í”¼ë“œì— ì¶”ê°€
            addToActivityFeed(data) {
                const feed = document.getElementById('activityFeed');
                const managerName = data.manager_name || managerMap[data.manager_id] || `ë§¤ë‹ˆì €${data.manager_id}`;
                const time = new Date(data.created_at).toLocaleTimeString('ko-KR');
                
                const activityHtml = `
                    <div class="activity-item">
                        <div class="activity-time">${time}</div>
                        <div class="activity-text">
                            <span class="activity-counselor">${managerName}</span>ë‹˜ì´ 
                            <span class="activity-customer">${data.customer_name || 'ê³ ê°'}</span>ë‹˜ì˜
                            ë¹„ë‹´ë‹¹ ìƒë‹´ì— ë‹µë³€
                            <span class="activity-chars">(${data.char_count}ì)</span>
                        </div>
                    </div>
                `;
                
                // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ í‘œì‹œ
                this.activityFeed.unshift(activityHtml);
                if (this.activityFeed.length > 20) {
                    this.activityFeed.pop();
                }
                
                feed.innerHTML = this.activityFeed.join('');
                document.getElementById('feedCount').textContent = `${this.activityFeed.length}ê°œ í™œë™`;
            },
            
            // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateRealtimeStatus(status) {
                const dot = document.getElementById('realtimeDot');
                const text = document.getElementById('realtimeText');
                
                switch(status) {
                    case 'SUBSCRIBED':
                        dot.className = 'pulse-dot';
                        text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                        break;
                    case 'CHANNEL_ERROR':
                        dot.className = 'pulse-dot disconnected';
                        text.textContent = 'ì—°ê²° ì˜¤ë¥˜';
                        break;
                    case 'TIMED_OUT':
                        dot.className = 'pulse-dot disconnected';
                        text.textContent = 'ì—°ê²° ì‹œê°„ì´ˆê³¼';
                        break;
                    default:
                        dot.className = 'pulse-dot connecting';
                        text.textContent = 'ì—°ê²° ì¤‘...';
                }
            },
            
            // ì‹¤ì‹œê°„ ëª¨ë“œ í† ê¸€
            toggleRealtime() {
                const btn = document.getElementById('realtimeBtn');
                if (this.realtimeChannel) {
                    supabase.removeChannel(this.realtimeChannel);
                    this.realtimeChannel = null;
                    btn.textContent = 'âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ ì¼œê¸°';
                    this.updateRealtimeStatus('CLOSED');
                } else {
                    this.setupRealtime();
                    btn.textContent = 'âš¡ ì‹¤ì‹œê°„ ëª¨ë“œ ë„ê¸°';
                }
            },
            
            // ì±„ë„í†¡ API ë™ê¸°í™”
            async syncChannelTalk() {
                const btn = document.getElementById('syncBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> ë™ê¸°í™” ì¤‘...';
                
                try {
                    // Vercel API í˜¸ì¶œ
                    const response = await fetch('/api/channel-sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            date: new Date().toISOString().split('T')[0]
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showNotification(`ì±„ë„í†¡ ë™ê¸°í™” ì™„ë£Œ: ${result.processed}ê°œ ì²˜ë¦¬ë¨`, 'success');
                        await this.loadData();
                    } else {
                        // ë¡œì»¬ í™˜ê²½ì´ê±°ë‚˜ APIê°€ ì—†ëŠ” ê²½ìš°
                        this.showNotification('API ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Vercelì— ë°°í¬ í›„ ì‚¬ìš©í•˜ì„¸ìš”.', 'error');
                    }
                    
                } catch (error) {
                    console.error('ì±„ë„í†¡ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                    this.showNotification('ì±„ë„í†¡ ë™ê¸°í™” ì‹¤íŒ¨', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'ì±„ë„í†¡ ë™ê¸°í™”';
                }
            },
            
            // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
            exportData() {
                if (this.currentData.length === 0) {
                    this.showNotification('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const csv = this.convertToCSV(this.currentData);
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `channel_talk_non_assignee_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
            },
            
            // CSV ë³€í™˜
            convertToCSV(data) {
                const headers = ['ì‹œê°„', 'ë§¤ë‹ˆì €ID', 'ë§¤ë‹ˆì €ëª…', 'ê³ ê°ëª…', 'ëŒ€í™”ID', 'ê¸€ììˆ˜', 'ì‘ë‹µì‹œê°„(ë¶„)', 'ë„ì›€ì—¬ë¶€'];
                const rows = data.map(item => [
                    new Date(item.created_at).toLocaleString('ko-KR'),
                    item.manager_id,
                    item.manager_name || managerMap[item.manager_id] || `ë§¤ë‹ˆì €${item.manager_id}`,
                    item.customer_name || '-',
                    item.user_chat_id,
                    item.char_count,
                    item.response_time || '',
                    item.is_helpful ? 'Y' : 'N'
                ]);
                
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            },
            
            // ì•Œë¦¼ í‘œì‹œ
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        };
        
        // ì•± ì‹œì‘
        app.init();
    </script>
</body>
</html>
