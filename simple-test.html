<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채널톡 API 테스트</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        button { background: #111; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; cursor: pointer; margin: 10px; }
        button:hover { background: #0f0; color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .log { background: #111; padding: 10px; margin: 10px 0; border: 1px solid #333; max-height: 400px; overflow-y: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>🔧 채널톡 API 테스트</h1>
    
    <div>
        <button onclick="testAPI()" id="testBtn">1. API 테스트 (1개 대화만)</button>
        <button onclick="checkToday()" id="checkBtn">2. 오늘 대화 확인</button>
        <button onclick="findHelps()" id="helpBtn">3. 도움 답변 찾기</button>
        <button onclick="clearLog()">로그 지우기</button>
    </div>
    
    <h3>로그:</h3>
    <div class="log" id="log"></div>
    
    <script>
        const API_KEY = '688a26176fcb19aebf8b';
        const API_SECRET = 'a0db6c38b95c8ec4d9bb46e7c653b3e2';
        let lastCall = 0;
        
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            logDiv.innerHTML += `<div${className}>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function wait(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
        
        async function callAPI(endpoint, params = {}) {
            // Rate limit: 1초 대기
            const now = Date.now();
            const elapsed = now - lastCall;
            if (elapsed < 1000) {
                log(`⏳ Rate limit 대기: ${1000 - elapsed}ms`, 'warning');
                await wait(1000 - elapsed);
            }
            lastCall = Date.now();
            
            const url = new URL(`https://api.channel.io/open/v5/${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'x-access-key': API_KEY,
                        'x-access-secret': API_SECRET
                    }
                });
                
                if (response.status === 429) {
                    log('❌ 429 Rate Limit! 5초 대기...', 'error');
                    await wait(5000);
                    return null;
                }
                
                if (!response.ok) {
                    log(`❌ API 에러: ${response.status}`, 'error');
                    return null;
                }
                
                return response.json();
            } catch (error) {
                log(`❌ 네트워크 에러: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testAPI() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            
            log('🔍 API 테스트 시작...');
            
            // 1개 대화만 가져오기
            const data = await callAPI('user-chats', {
                state: 'opened',
                limit: 1
            });
            
            if (data && data.userChats) {
                log(`✅ API 정상! ${data.userChats.length}개 대화 발견`, 'success');
                
                if (data.userChats.length > 0) {
                    const chat = data.userChats[0];
                    log(`대화 ID: ${chat.id}`);
                    log(`담당자: ${chat.assignee?.name || '없음'} (${chat.assignee?.id || 'N/A'})`);
                }
            } else {
                log('❌ API 실패', 'error');
            }
            
            btn.disabled = false;
        }
        
        async function checkToday() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            
            log('📅 오늘 대화 확인 중...');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let totalCount = 0;
            
            for (const state of ['opened', 'closed']) {
                log(`📂 ${state} 대화 조회...`);
                
                const data = await callAPI('user-chats', {
                    state: state,
                    limit: 20  // 적은 수만
                });
                
                if (data && data.userChats) {
                    const todayChats = data.userChats.filter(chat => {
                        const chatDate = new Date(chat.updatedAt || chat.createdAt);
                        return chatDate >= today;
                    });
                    
                    totalCount += todayChats.length;
                    log(`${state}: ${todayChats.length}개 (전체 ${data.userChats.length}개 중)`);
                }
                
                await wait(1000); // 1초 대기
            }
            
            log(`✅ 오늘 총 ${totalCount}개 대화`, 'success');
            
            btn.disabled = false;
        }
        
        async function findHelps() {
            const btn = document.getElementById('helpBtn');
            btn.disabled = true;
            
            log('🔍 도움 답변 찾기...');
            
            // 최근 opened 대화 5개만
            const data = await callAPI('user-chats', {
                state: 'opened',
                limit: 5
            });
            
            if (!data || !data.userChats) {
                log('❌ 대화 목록 실패', 'error');
                btn.disabled = false;
                return;
            }
            
            let helpCount = 0;
            
            for (const chat of data.userChats) {
                const assigneeId = chat.assignee?.id;
                if (!assigneeId) continue;
                
                log(`대화 ${chat.id} 확인 중...`);
                
                // 메시지 가져오기
                const msgData = await callAPI(`user-chats/${chat.id}/messages`, {
                    limit: 10
                });
                
                if (msgData && msgData.messages) {
                    for (const msg of msgData.messages) {
                        if (msg.personType === 'manager' && 
                            msg.personId && 
                            msg.personId !== assigneeId) {
                            helpCount++;
                            log(`✅ 도움 답변: ${msg.personId} → ${chat.id}`, 'success');
                        }
                    }
                }
                
                await wait(1000); // 1초 대기
            }
            
            log(`✅ 총 ${helpCount}개 도움 답변 발견`, 'success');
            
            btn.disabled = false;
        }
        
        // 시작
        log('준비 완료. 버튼을 클릭하세요.', 'success');
        log('⚠️ 429 에러 방지를 위해 1초 간격 유지', 'warning');
    </script>
</body>
</html>
