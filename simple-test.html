<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„ë„í†¡ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        button { background: #111; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; cursor: pointer; margin: 10px; }
        button:hover { background: #0f0; color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .log { background: #111; padding: 10px; margin: 10px 0; border: 1px solid #333; max-height: 400px; overflow-y: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ì±„ë„í†¡ API í…ŒìŠ¤íŠ¸</h1>
    
    <div>
        <button onclick="testAPI()" id="testBtn">1. API í…ŒìŠ¤íŠ¸ (1ê°œ ëŒ€í™”ë§Œ)</button>
        <button onclick="checkToday()" id="checkBtn">2. ì˜¤ëŠ˜ ëŒ€í™” í™•ì¸</button>
        <button onclick="findHelps()" id="helpBtn">3. ë„ì›€ ë‹µë³€ ì°¾ê¸°</button>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>
    
    <h3>ë¡œê·¸:</h3>
    <div class="log" id="log"></div>
    
    <script>
        const API_KEY = '688a26176fcb19aebf8b';
        const API_SECRET = 'a0db6c38b95c8ec4d9bb46e7c653b3e2';
        let lastCall = 0;
        
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            logDiv.innerHTML += `<div${className}>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function wait(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
        
        async function callAPI(endpoint, params = {}) {
            // Rate limit: 1ì´ˆ ëŒ€ê¸°
            const now = Date.now();
            const elapsed = now - lastCall;
            if (elapsed < 1000) {
                log(`â³ Rate limit ëŒ€ê¸°: ${1000 - elapsed}ms`, 'warning');
                await wait(1000 - elapsed);
            }
            lastCall = Date.now();
            
            const url = new URL(`https://api.channel.io/open/v5/${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'x-access-key': API_KEY,
                        'x-access-secret': API_SECRET
                    }
                });
                
                if (response.status === 429) {
                    log('âŒ 429 Rate Limit! 5ì´ˆ ëŒ€ê¸°...', 'error');
                    await wait(5000);
                    return null;
                }
                
                if (!response.ok) {
                    log(`âŒ API ì—ëŸ¬: ${response.status}`, 'error');
                    return null;
                }
                
                return response.json();
            } catch (error) {
                log(`âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testAPI() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            
            log('ğŸ” API í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            // 1ê°œ ëŒ€í™”ë§Œ ê°€ì ¸ì˜¤ê¸°
            const data = await callAPI('user-chats', {
                state: 'opened',
                limit: 1
            });
            
            if (data && data.userChats) {
                log(`âœ… API ì •ìƒ! ${data.userChats.length}ê°œ ëŒ€í™” ë°œê²¬`, 'success');
                
                if (data.userChats.length > 0) {
                    const chat = data.userChats[0];
                    log(`ëŒ€í™” ID: ${chat.id}`);
                    log(`ë‹´ë‹¹ì: ${chat.assignee?.name || 'ì—†ìŒ'} (${chat.assignee?.id || 'N/A'})`);
                }
            } else {
                log('âŒ API ì‹¤íŒ¨', 'error');
            }
            
            btn.disabled = false;
        }
        
        async function checkToday() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            
            log('ğŸ“… ì˜¤ëŠ˜ ëŒ€í™” í™•ì¸ ì¤‘...');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let totalCount = 0;
            
            for (const state of ['opened', 'closed']) {
                log(`ğŸ“‚ ${state} ëŒ€í™” ì¡°íšŒ...`);
                
                const data = await callAPI('user-chats', {
                    state: state,
                    limit: 20  // ì ì€ ìˆ˜ë§Œ
                });
                
                if (data && data.userChats) {
                    const todayChats = data.userChats.filter(chat => {
                        const chatDate = new Date(chat.updatedAt || chat.createdAt);
                        return chatDate >= today;
                    });
                    
                    totalCount += todayChats.length;
                    log(`${state}: ${todayChats.length}ê°œ (ì „ì²´ ${data.userChats.length}ê°œ ì¤‘)`);
                }
                
                await wait(1000); // 1ì´ˆ ëŒ€ê¸°
            }
            
            log(`âœ… ì˜¤ëŠ˜ ì´ ${totalCount}ê°œ ëŒ€í™”`, 'success');
            
            btn.disabled = false;
        }
        
        async function findHelps() {
            const btn = document.getElementById('helpBtn');
            btn.disabled = true;
            
            log('ğŸ” ë„ì›€ ë‹µë³€ ì°¾ê¸°...');
            
            // ìµœê·¼ opened ëŒ€í™” 5ê°œë§Œ
            const data = await callAPI('user-chats', {
                state: 'opened',
                limit: 5
            });
            
            if (!data || !data.userChats) {
                log('âŒ ëŒ€í™” ëª©ë¡ ì‹¤íŒ¨', 'error');
                btn.disabled = false;
                return;
            }
            
            let helpCount = 0;
            
            for (const chat of data.userChats) {
                const assigneeId = chat.assignee?.id;
                if (!assigneeId) continue;
                
                log(`ëŒ€í™” ${chat.id} í™•ì¸ ì¤‘...`);
                
                // ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                const msgData = await callAPI(`user-chats/${chat.id}/messages`, {
                    limit: 10
                });
                
                if (msgData && msgData.messages) {
                    for (const msg of msgData.messages) {
                        if (msg.personType === 'manager' && 
                            msg.personId && 
                            msg.personId !== assigneeId) {
                            helpCount++;
                            log(`âœ… ë„ì›€ ë‹µë³€: ${msg.personId} â†’ ${chat.id}`, 'success');
                        }
                    }
                }
                
                await wait(1000); // 1ì´ˆ ëŒ€ê¸°
            }
            
            log(`âœ… ì´ ${helpCount}ê°œ ë„ì›€ ë‹µë³€ ë°œê²¬`, 'success');
            
            btn.disabled = false;
        }
        
        // ì‹œì‘
        log('ì¤€ë¹„ ì™„ë£Œ. ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'success');
        log('âš ï¸ 429 ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ 1ì´ˆ ê°„ê²© ìœ ì§€', 'warning');
    </script>
</body>
</html>
